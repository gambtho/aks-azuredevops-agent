name: Agent-$(Date:yyyyMMdd).$(Rev:.r)
trigger:
  batch: true
  branches:
    include:
    - master
    - dev

variables:
  - group: ado-kv
  - group: ado-config
  - group: tapm

stages: 
  - stage: init
    displayName: Init
    jobs: 
    - job: setup 
      displayName: Terraform Validate and Publish
      pool:
        vmImage: 'ubuntu-16.04'
      steps: 
      - template: templates/setup.yml
  - stage: dev
    displayName: Dev  
    jobs:
    - job: plan
      displayName: plan
      pool:
        vmImage: 'ubuntu-16.04'
      steps: 
      - template: templates/plan.yml
        parameters:
          env: $(ADOENV)
          azure_sub: $(azure_sub)
          name: $(ADONAME)
          ARMCLIENTID: $(ARM-CLIENT-ID)
          ARMCLIENTSECRET: $(ARM-CLIENT-SECRET)
    - deployment: apply
      displayName: apply
      environment: dev
      pool:
        vmImage: 'ubuntu-16.04'
      dependsOn: plan
      strategy:
        runOnce:
          deploy:
            steps:
              - template: templates/apply.yml
                parameters: 
                  env: $(ADOENV)
                  azure_sub: $(azure_sub)
                  name: $(ADONAME)
                  ARMCLIENTID: $(ARM-CLIENT-ID)
                  ARMCLIENTSECRET: $(ARM-CLIENT-SECRET)
                  ADOTOKEN: $(ADO-TOKEN)
                  ADOPOOL: $(ADO-POOL)
                  ADOORG: $(ADO-ORG)