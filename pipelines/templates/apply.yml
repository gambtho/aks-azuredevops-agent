parameters:
  env: ''
  azure_sub: ''
  name: ''
  ARMCLIENTID: ''
  ARMCLIENTSECRET: ''

steps:
- task: DownloadPipelineArtifact@2
  inputs:
    artifact: plan
    path: '$(System.DefaultWorkingDirectory/terraform'
# - task: AzureCLI@2
#   displayName: Init
#   inputs:
#     azureSubscription: ${{parameters.azure_sub}} 
#     scriptType: bash
#     scriptLocation: inlineScript
#     inlineScript: |
#         RESOURCE_GROUP_NAME=${{parameters.name}}${{parameters.env}}
#         ARM_SUBSCRIPTION_ID=$(az account show --query id --out tsv)
#         ARM_TENANT_ID=$(az account show --query tenantId --out tsv)
#         az account set --subscription $ARM_SUBSCRIPTION_ID
#         cd ./terraform
#         terraform init -upgrade -input=false \
#             -backend-config="resource_group_name=$RESOURCE_GROUP_NAME" \
#             -backend-config="storage_account_name=$RESOURCE_GROUP_NAME" \
#             -backend-config="client_secret=${{parameters.ARMCLIENTSECRET}}" \
#             -backend-config="subscription_id=$ARM_SUBSCRIPTION_ID" \
#             -backend-config="tenant_id=$ARM_TENANT_ID" \
#             -backend-config="key=${{parameters.env}}.tfstate" \
#             -backend-config="container_name=${{parameters.env}}" \
#             -backend-config="client_id=${{parameters.ARMCLIENTID}}"     
- task: AzureCLI@2
  displayName: Apply
  inputs:
    azureSubscription: ${{parameters.azure_sub}} 
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
        ARM_SUBSCRIPTION_ID=$(az account show --query id --out tsv)
        ARM_TENANT_ID=$(az account show --query tenantId --out tsv)
        az account set --subscription $ARM_SUBSCRIPTION_ID
        cd ./terraform
        ls -l
        terraform apply ${{parameters.env}}.plan
- task: AzureCLI@2
  displayName: Config
  inputs:
    azureSubscription: ${{parameters.azure_sub}} 
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
        RESOURCE_GROUP_NAME=${{parameters.name}}${{parameters.env}}
        ARM_SUBSCRIPTION_ID=$(az account show --query id --out tsv)
        az account set --subscription $ARM_SUBSCRIPTION_ID
        az aks get-credentials --admin --name $RESOURCE_GROUP_NAME-aks --resource-group $RESOURCE_GROUP_NAME

        az configure --defaults acr=${RESOURCE_GROUP_NAME}
        az acr build -t azpagent:latest ../azpdocker/

        # kubectl apply -f ../config/kured.yaml

        helm init 

        az acr helm repo add

        echo "pushing agent to helm"

        cd ../azpagent 
        set +e
        helm package .
        ls -l *.tgz
        az acr helm push --force *.tgz
        rm -rf *.tgz
        set -e
        cd - 

        helm repo update
        az acr helm list

        echo "deploying agent to k8s"

        ADO_TOKEN=$(tr -dc '[[:print:]]' <<< ${ADO_TOKEN})
        ADO_POOL=$(tr -dc '[[:print:]]' <<< ${ADO_POOL})
        ADO_URL=$(tr -dc '[[:print:]]' <<< ${ADO_URL})
        ADO_ACCOUNT=$(tr -dc '[[:print:]]' <<< ${ADO_ACCOUNT})

        helm upgrade --install azpagent ${RESOURCE_GROUP_NAME}/azpagent \
            --set azp.url=${ADO_URL},azp.token=${ADO_TOKEN},azp.pool=${ADO_POOL} \
            --set image.repository=${RESOURCE_GROUP_NAME}.azurecr.io/azpagent 